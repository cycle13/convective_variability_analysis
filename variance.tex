% \documentclass[a4paper, 12pt, draft]{article}
\documentclass[a4paper, 12pt]{article}
\usepackage{natbib}
\usepackage{graphicx}
\usepackage{tikz}   % For the for loop
\usepackage[top=3cm, bottom=3cm, left=2.5cm, right=2.5cm]{geometry}
\graphicspath{{/home/s/S.Rasp/Dropbox/figures/PhD/variance/}}

\title{Convective variability in real mid-latitude weather: Which model best explains it?}

\begin{document}
\maketitle\

\tableofcontents
	
\section{Introduction}

\subsection{The cumulus parameterization problem}

Convection in the atmosphere is an important process which modifies its environment by redistributing heat, moisture and momentum. It is, however, also a process which is small in scale: typical cloud sizes range from 1\,km for shallow cumulus clouds to 10\,km for deep convective clouds. Current global climate and weather models with grid spacings of 100\,km and 10\,km, respectively, are therefore unable to explicitly represent convection and rely on parameterizations to describe the effect of the unresolved convection on the resolved grid-scale. Most state-of-the-art models use a mass-flux approach (see Fig.~\ref{fig:conceptual}) where a cloud base mass flux is used as an input for a one-dimensional cloud model which describes the mixing of updraft air with its environment, and thereby the temperature and moisture transfer. The effect of all subgrid clouds can either be represented by one single cloud in a bulk approach, or by a representative sample of clouds in what is called a spectral cloud model. The cloud base mass flux is determined by the closure assumption which itself is a function of the resolved scales, and can for instance be based on a removal of CAPE within a certain time scale. In most current operational models, parameterizations are deterministic in nature. This means that for a given large-scale state the parameterization will always produce the same output. If a model grid box contains many cloud features this approximation might be reasonable. As grid spacing become smaller, however, this determinism breaks down and fluctuations become non-negligible. Ignoring this subgrid variability can lead to systematic biases, under-representations of extremes and underdispersion in ensemble prediction systems. The last point has been recognized early and several ad hoc methods have been proposed to combat this lack of spread, the most prominent being SPPT. Here the parameterized tendencies are multiplied by a random factor which varies spatially and temporally: 
\begin{equation} \label{eq:SPPT}
 \dot{\Phi} = (1 + \eta) \dot{\Phi}_{\mathrm{param}},
\end{equation}
where $\Phi$ represents any model variable and $\eta$ is a random variable with mean zero. The intrinsic assumption of this approach is that the standard deviation of the tendencies is proportional to the mean:
\begin{equation} \label{eq:SPPT_std}
 \langle (\delta \dot{\Phi})^2 \rangle^{1/2} = b \langle \dot{\Phi} \rangle.
\end{equation}
The factor $b$ depends on the distribution of the random number $\eta$. SPPT is applied to all parameterizations with the same random field. This approach has been very successful in making weather models more reliable.

It has been increasingly recognized, however, that stochastic parameterizations should be process specific for several reasons. First, different physical processes might display different levels of uncertainty. While convection is a very uncertain process, for example, radiation, on the other hand, might have very small fluctuations. Second, 

\subsection{The \cite{Craig2006} theory}

One theoretical model for convective variability based on statistical mechanics has been developed by \cite{Craig2006}(CC06). In their work, the aim is to quantify the fluctuations of mass flux given a certain mean mass flux $\langle M \rangle$, which is a function of the large-scale atmospheric state. The distributions of $N$ and $m$ are given by 
\begin{equation} \label{eq:m_dist}
 P(m) = \frac{1}{\langle m \rangle}e^{-m/\langle m \rangle}
\end{equation}
and 
\begin{equation} \label{eq:N_dist}
 P(N) = \frac{\langle N \rangle^N}{N!}e^{-\langle N \rangle}.
\end{equation}
Combing these, the distribution of the total mass flux $M$ is given by
\begin{equation} \label{eq:M_dist}
 P(M) = \left( \frac{\langle N \rangle}{\langle m \rangle} \right)^{1/2} e^{-\langle N \rangle} M^{-1/2} e^{-M/\langle m \rangle} I_1\left[ 2 \left( \frac{\langle N \rangle}{\langle m \rangle} M \right)^{1/2} \right],
\end{equation}
where $I_1(x)$is the modified Bessel function of order 1. For large (small) values of $\langle N \rangle$ the shape of this function resembles a Gaussian (Poisson) distribution. The normalized variance is given by 
\begin{equation} \label{eq:M_var}
 \frac{\langle (\delta M)^2 \rangle}{\langle M \rangle^2} = \frac{2}{\langle N \rangle}.
\end{equation}
Note that $\langle M \rangle = \langle N \rangle \langle m \rangle$. Equivalently,
\begin{equation} \label{eq:M_std}
 \langle (\delta M)^2 \rangle^{1/2}= \sqrt{2 \langle M \rangle \langle m \rangle}.
\end{equation}
Note that in contrast to Eq.~\ref{eq:SPPT_std}, the standard deviation here is proportional to the square root of the mean. This theory has been tested in a radiative-convective-equilibrium simulation by \cite{Cohen2006}. The simulated variance scaling agrees well with the theoretical prediction (with an error of 10\%). \cite{Davies2008} and \cite{Davoudi2010} included a diurnal cycle in their simulations. In both studies, clustering (defined as the increased probability of cloud occurrence near already existing clouds) acts to modify the normalized variability. In particular \cite{Davies2008} found a strong diurnal cycle with increased clustering and variability in the morning and evening hours. 

The CC06 theory was then used by \cite{Plant2008}(PC08) to create a stochastic parameterization. In their approach, clouds are randomly drawn from an exponential distribution described by Eq.~\ref{eq:m_dist} consistent with an $\langle M \rangle$ given by the closure assumption. $\langle m \rangle = 2 \times 10^7$kg s$^{-1}$ is assumed to be a constant. This assumption is motivated by RCE simulations \citep[e.g.][]{Cohen2006}. From this stochastic cloud ensemble the large-scale tendencies are then computed as the sum of the cloud model output for each plume in a spectral approach. The theoretical prediction for the variance of $M$ (Eq. \ref{eq:M_var}) is not explicitly used in PC08, but comes from the exponential $m$ distribution combined with the random initiation of new clouds. The cloud life time is set to 45 minutes for all clouds. 

\subsection{Research question / Aim of this study}

The primary goal of this study is to investigate the convective variability in real mid-latitude weather by using a novel approach based on a stochastic boundary-layer perturbation scheme. In particular, we want to see how well the theoretical predictions of CC06 and SPPT fit and how good the assumptions underlying the theories are. This will allow us to identify key processes which have to be included to improve stochastic convection schemes. 


\section{Numerical experiments and case studies} \label{sec:numerical}
The aim is to create an ensemble of simulations of real mid-latitude weather in which the large-scale conditions are sufficiently similar, but the convective clouds have been completely displaced. The first condition is achieved by using the same initial and boundary condition for each ensemble member. To fulfill the second condition a stochastic boundary layer perturbation scheme is used. The model and the boundary layer scheme will be described now. 

\subsection{Model description and set-up}
The model used is the COSMO model \citep{Baldauf2011} with a horizontal grid spacing $\Delta x=$2.8\,km. The setting are the same as in the operational COSMO-DE setup with one exception, the stochastic boundary-layer scheme which will be described below. The model does not parameterize deep convection, but a parameterization for shallow convection is included. The domain size is 357 grid points in either direction with the domain centered at 10E and 50N. For the analysis a 256 by 256 grid point domain (roughly 717km) at the center of the simulation domain is considered (see Fig.~\ref{fig:prec_stamps}). The 50 grid point gap to the boundary ensures that boundary spin-up effects are minimal. 

Initial and boundary conditions are taken from the operational COSMO-EU (7km) deterministic forecast with a boundary condition update frequency of 1 h. All runs are started at 00UTC with a lead time of 24 h. A 50 member ensemble is created by setting a different random number seed in the stochastic boundary-layer scheme for each member. The output frequency is 30\,minutes.

\subsection{The PSPturb turbulence scheme}
The physically-based stochastic perturbation boundary-layer scheme (PSPturb) is described and tested in \cite{Kober2016}(KC16). A brief outline is given here now. The PSPturb scheme is an additive perturbation scheme:
\begin{equation} \label{eq:PSPturb_additive}
\\dot{\Phi}_{\mathrm{total}} = \dot{\Phi}_{\mathrm{parameterized}} + \eta \sigma_{\dot{\Phi}_{\mathrm{parameterized}}}
\end{equation}
These perturbations (last term) are process-specific, so for each parameterized process the perturbations have to be calculated separately. The last term in the equation above contains a random number $\eta = \mathit{N}(0,1)$ and the standard deviation $\sigma$ of the parameterized tendencies. The random number field has a horizontal correlation length of 5$\Delta x$, the effective resolution of a numerical model \citep{Skamarock2004}, and is held constant for 10 minutes and then drawn again from scratch. This represents a typical eddy turnover time in the boundary layer. In KC16 the standard deviation term is approximated by
\begin{equation} \label{eq:PSPturb_std}
\sigma_{\dot{\Phi}_{\mathrm{parameterized}}} = \alpha_{\mathrm{const}, \Phi} \frac{\mathit{l_{\infty}}}{5 \Delta x}\frac{1}{dt} \sigma_{\Phi},
\end{equation}
where $\mathit{l_{\infty}} = 150$ m is the mixing length describing the average size of an eddy. The term $\sigma_{\Phi}$ is the sub-grid scale standard deviation. For the turbulence perturbations the considered variables are vertical velocity $w$, potential temperature $\theta$ and humidity $q$. The standard deviations are calculated in the turbulence parameterization (see KC16 for details). The factor $\frac{\mathit{l_{\infty}}}{5 \Delta x} \propto 1/\sqrt{N_{\mathrm{eddy}}}$ scales the variability according to number of unresolved eddies similar to Eq. \ref{eq:M_var}. The factor $\frac{1}{dt}$  converts the term into a tendency term dependent on the time step. Finally, a scaling factor $\alpha_{\mathrm{const}, \Phi}$ is included for tuning purposes and should be of order one. It is set to 2 for these experiments. 

\subsection{Simulation period}
The simulations were run for a continuous 12 day period from 28 May -- 8 June 2016 which was characterized by strong convective rainfall over Central Europe (ask Christian for a review of this period). For a large portion of this period a low pressure system was stationed over the Central Alpine region causing South-Easterly advection over Germany. The precipitation largely followed a typical diurnal cycle (Fig.~\ref{fig:summary_weather}), along with a build up of convective available potential energy (CAPE) in the morning and a growing boundary layer (using as a measure the perturbed boundary layer height model output). The convective adjustment time scale $\tau_c$, a measure of the synoptic forcing, shows intermediate values of around 5\,h indicating moderate synoptic forcing, typical for the scattered convection seen in most of the simulated days (for an introduction to $\tau_c$ see \cite{Done2006}, for a recent paper describing the calculation method used here see \cite{Flack2016}).

\subsection{Are the simulations realistic?} 
To test whether the numerical simulations can represent convection realistically, the precipitation fields are compared to Radar-derived precipitation observations. A visual impression of the similarity between model output and observations can be gained from Fig.~\ref{fig:prec_stamps}. To get a quantitative picture a precipitation histogram is used to check whether the simulations produce a realistic distribution of rain (Fig.~\ref{fig:prec_hist}). Overall the agreement is good. The model seems to produce slightly more very light rain and very heavy rain. To test whether the spatial distribution of clouds is comparable we show the radial distribution function (Fig.~\ref{fig:prec_rdf}). This is particularly important since clustering will turn out to be an important factor in modulating convective variability. Both, simulations and observations, show a diurnal cycle with a clustering minimum during the convective maximum at around 15\,UTC and increased clustering towards the evening hours. In general the clustering in the model appears to be sharper, meaning that the peak is larger, but then drops off faster. This implies that the model likes to produce clouds directly next to existing clouds (partly this can be an artifact of the cloud separation method), but is less likely to produce larger clusters, a known problem in convection-permitting models. With this in mind, we can still conclude that the model simulations are a realistic representation of convection. 

\subsection{Are the large scales sufficiently similar and the convective scales sufficiently displaced?} 
The premise of this study is that the convective scales are completely displaced, while the large-scale conditions are reasonably similar. A visual, qualitative test of this assumption is show in Fig.~\ref{fig:prec_stamps}. On the large scales the members agree on the location of the precipitation, but zooming in on the convection itself reveals no perceptible correlation. A more quantitative approach is given by the ratio of the difference to the background energy spectra of kinetic energy and precipitation (Fig.~\ref{fig:spectra}). A complete displacement at a given scale would result in a difference energy which is twice the background energy. The precipitation, representative of the convective features, shows some error growth early in the simulations. By 06\,UTC, the displacement for scales up to 50\,km is mostly complete. We, therefore, choose 06\,UTC to start our analysis. To see how similar the large-scale environment is we look at the difference kinetic energy spectrum. Here the largest scales seem to agree very well (with a ratio of around 10\%) even at later times after the errors have grown. The small scales show a strong upscale error growth, suggesting that it takes longer for the displacement to be complete in the wind field. Since we are interested in the convection, however, it is sufficient if the convective features (i.e. the precipitation) is completely displaced. We therefore conclude that the basic assumption of displaced small scales and comparable large scales is met.


\section{Computation of $M$ and $Q$ statistics}

\subsection{Mass flux $M$}
The vertical mass flux is defined as the mass of air crossing a certain horizontal area per unit time. Since our interest is in the convective mass flux, we first have to identify the convective clouds (for an illustration of the process see Fig.~\ref{fig:Fig4}). To do this we follow \cite{Cohen2006} and many other previous and subsequent studies by creating a binary cloud/no cloud field using a threshold for vertical velocity $w >$ 1 m s$^{-1}$ combined with a positive cloud water content $q_c >$ 0 kg kg$^{-1}$. By doing this we aim to identify convective updrafts, ignoring downdrafts. Next, contiguous areas are identified as clouds using a 4-point segmentation algorithm so that only pixels which share an edge are considered as contiguous clouds. Additionally, ``overlapping'' clouds are identified with the local maximum method, followed by a watershed algorithm to find the extent of each separated cloud.

For each identified cloud $k=1,...,N_{\mathrm{cld},i}$ in each ensemble member $i=1,...,N_{\mathrm{ens}}$ a cloud size $\sigma_k$ is determined as
\begin{equation} \label{eq:cld_size}
 \sigma_k = N_{px} \Delta x^2,
\end{equation}
where $N_{\mathrm{px}}$ is the number of pixels for each cloud $k$. The mass flux per cloud $m_k$ is computed as
\begin{equation} \label{eq:mass_flux_per_cloud}
 m_k = \Delta x^2 \sum_{l}^{N_{\mathrm{px}}} w_l \rho_l,
\end{equation}
where $\rho$ is density.

The mass flux calculation have to be done at a certain vertical level. Ideally one would chose the cloud base mass flux, which serves as the input for many cloud models used in convective parameterizations. In our simulations, however, the height of the cloud base varies temporally and spatially. We want to make sure that we are always above the boundary layer. Another complication in our real case studies is the orography. The surface elevation varies by more than 500\,m in the analysis domain (see bottom left panel in Fig.~\ref{fig:prec_stamps}). The terrain-following model levels were chosen as a good compromise between a height above ground level approach close to the surface and a height above sea level approach at higher altitudes. Fig.~\ref{fig:vert} shows vertical profiles of the domain integrated mass flux at two different times (others are similar). The level at which the maximum mass flux appears changes only slightly with time and is typically located around level 30, which was chosen to conduct our analysis. This corresponds to a height of around 3000\,m for a column located above sea level. Additionally, the profiles for the Northern and Southern half of the analysis domain show a good agreement. In Appendix B the sensitivity of the diagnostics to the analysis height is shown.

\subsection{Heating rate $Q$}
The heating rate used here is the temperature tendency computed by the microphysics parameterization. It is, therefore, not purely restricted to convective heating or cooling, which would be $Q1$ in the typical notation. $Q$ was summed in the vertical to represent the total heating in the column.

\subsection{Calculation of ensemble means and variances}
For the variance calculations, a coarse-graining is applied to create coarse boxes $j=1,...,N_{\mathrm{box,n}}$ with edge lengths of $n=$ 256, 128, 64, 32, 16, 8 and 4$\Delta x$, where $N_{\mathrm{box,n}}=(256/n)^2$. No smaller neighborhoods are considered, since these would be significantly below the effective resolution of the model. The total mass flux per box per member $M_{i,j,n}$ is given by
\begin{equation} \label{eq:calc_memM}
 M_{i,j,n} = \sum_{k=1}^{N_{\mathrm{cld}\,i,j,n}} m_{k,i,j,n}.
\end{equation}
To deal with clouds at the boundaries of the coarse-fields, the centers of mass for each cloud is first identified. Then the $m_k$ is attributed to that one point in space. Therefore, the coarse box which contains the center of mass also contains the entire cloud, while the other box does not contain any of the cloud. This follows \cite{Cohen2006}. $N_{i,j,n}=N_{\mathrm{cld}\,i,j,n}$ is simply the number of clouds which fall into each box.  The heating rate per box $Q_{i,j,n}$ is simply the average of all grid points in the box.

Ensemble statistics of $\Phi = M, N, Q$ are then calculated for each box $j$. The sample variance is computed as
\begin{equation} \label{eq:calc_varM}
 \langle (\delta \Phi )^2 \rangle_{j,n} = \frac{1}{N_{\mathrm{ens}}-1} \sum_{i=1}^{N_{\mathrm{ens}}} (\Phi_{i,j,n} - \langle \Phi \rangle_{j,n})^2,
\end{equation}
where the ensemble mean is
\begin{equation} \label{eq:calc_meanM}
 \langle \Phi \rangle_{j,n} = \frac{1}{N_{\mathrm{ens}}} \sum_{i=1}^{N_{\mathrm{ens}}} \Phi_{i,j,n}.
\end{equation}

To compute statistics for $m$ a different approach is taken. Here the clouds in all members for each box are considered together to calculate the variance and mean. The total number of clouds over all ensemble members is denoted by $N_{\mathrm{cldtot}} = \sum_{i=1}^{N_{\mathrm{ens}}} N_{\mathrm{cld}\,i,j,n}$.
\begin{equation} \label{eq:calc_varm}
 \langle (\delta m )^2 \rangle_{j,n} = \frac{1}{N_{\mathrm{cldtot}}-1} \sum_{k=1}^{N_{\mathrm{cldtot}}} (m_{k,j,n} - \langle m \rangle_{j,n})^2,
\end{equation}
where the mean is
\begin{equation} \label{eq:calc_meanm}
 \langle m \rangle_{j,n} = \frac{1}{N_{\mathrm{cldtot}}} \sum_{k=1}^{N_{\mathrm{cldtot}}} m_{k,j,n}.
\end{equation}
% 
% Since we are sampling a distribution with a limited number of data points $N_{\mathrm{ens}}$, sampling issues arise when $\langle N \rangle$ becomes small ($\approx \frac{1}{N_{\mathrm{ens}}}$). In particular, if only one member contains a cloud chances are that the real $\langle N \rangle < \frac{1}{N_{\mathrm{ens}}}$ and we therefore overestimate the mean mass flux $\langle M \rangle$. To avoid this issue, a criterion is introduced where at least 5 out of 20 ensemble members must contain at least one cloud. \textit{This threshold is a quick fix and there probably should be a threshold with better reasoning.}

Composites were computed by averaging over the 12 days in the simulation period. For the calculation of means and standard deviations, all coarse boxes at scale $n$ for all ensemble members were first combined, and then the means and standard deviations were calculated. This ensures that, since the number of coarse boxes with clouds will differ from case to case, every coarse box is weighted equally.


\section{Simulation results}
\subsection{Relationship between variability and mean}
Our dataset now contains values of $\langle M \rangle$, $\langle (\delta M )^2 \rangle$, $\langle Q \rangle$, $\langle (\delta Q )^2 \rangle$ for each coarsening scale $n$, grid box $j$ and time $t$. We now proceed to test the functional dependence of the variability in terms of standard deviation on the mean values. Specifically, we would like to test Eq.~\ref{eq:SPPT_std} and Eq.~\ref{eq:M_std}. Fig.~\ref{fig:std_v_mean}a shows a scatter plot of $\langle (\delta M )^2 \rangle^{1/2}$ and $\langle M \rangle$ for all data points. Additionally, least square fits are plotted for a linear relationship $y = bx$ (c.f. Eq.~\ref{eq:SPPT_std}) and a square root relationship $y = \sqrt{(bx)}$ (c.f. Eq.~\ref{eq:M_std}) for each coarsening scale separately. In Fig.~\ref{fig:std_v_mean}b the fitting parameter $b$ is plotted for each scale (note that for the square root fit $b$ was divided by a factor given in the legend to fit the scale) along with the normalized root mean squared error (NRMSE) of the fit, computed as $NRMSE = \sqrt{1/N \sum^N (\langle (\delta M )^2 \rangle^{1/2} - (b\langle M \rangle)^p/\langle (\delta M )^2 \rangle^{1/2}}$ with $p=1$ for the linear fit and $p=1/2$ for the square root fit. The two main results are: (i) the square root fit is better than the linear fit for all scales as measured by the NRMSE; (ii) the square root fit is scale adaptive. The fitting parameter $b$ for the linear fit decreases as the coarsening scale increases, while for the square root fit $b$ stays relatively constant with variations of around 30\%. These results suggest that the CC06 scaling applies reasonably well for our real-world data. In particular it is scale-aware. The linear assumption does not seem to fit the mass flux variability very well. SPPT, based on a linear assumption, is not defined for the mass flux, however, but for the output of the parameterizations, such as the heating tendency. We, therefore, want to test whether the finding for $M$ also apply to $Q$.

The first step is to see how well the means and standard deviations of $M$ and $Q$ correlate (Fig.~\ref{fig:std_v_mean}d). For all scales there seems to be a good correlation, particularly for the variability. A scatter plot of $\langle (\delta Q )^2 \rangle^{1/2} A$ and $\langle Q \rangle A$ (Fig.~\ref{fig:std_v_mean}c; the factor $A=n^2$ has to be introduced since $Q$ is an average quantity while $M$ is a summed quantity)reveals one major difference between the two variables. Whereas $M$, by definition, cannot be negative, $Q$ can. Both SPPT and CC06 are designed so that the variability goes to zero as the mean goes to zero. This offset was recognized by \cite{Shutts2007} who argue that for the convective heating rate (note the different methodologies) the standard deviation depends linearly on the mean, but with a offset at zero mean. To further test how well the linear CC06 theory applies to the heating rate, $\langle (\delta Q )^2 \rangle^{1/2} A$ is scattered against $\langle M \rangle$ (Fig.~\ref{fig:std_v_mean}e). Again least square fits are computed for Fig.~\ref{fig:std_v_mean}c and e along with the NRMSE (Fig.~\ref{fig:std_v_mean}f). The results mirror these of the $M$ fits, albeit with larger errors. Overall, $Q$ and $M$ behave reasonably similar suggesting that for our data a square root relation between the standard deviation and mean represents a good, scale-adaptive model of convective variability. There are, however, still significant deviations of our simulation data from the fitted curves, which we will investigate now. 

\section{Testing the assumptions of CC06 and PC08}
Specifically, we will test how well the predicted variance corresponds with the variance computed from the simulation data by taking the ratio of the two. The starting point is the variance which follows from using the PC08 scheme, which in addition to all CC06 assumptions also assumes that $\langle m \rangle$ is constant. We take $\langle m \rangle = m_c = 4\times10^7$kg s$^{-1}$, which is close to the mean for our simulations (see FIG???). A scatter plot showing the simulation to prediction ratio along with the temporal evolution of the mean values for each scale is shown in Fig.~\ref{fig:scatter}a,b. On average, the predictions are good, but the fluctuations around the mean are large. In addition, there is a distinct diurnal cycle visible with an increase from 15--18UTC, indicating that the theory over-predicts the variability in the morning up to the convective maximum at around 15UTC, and subsequently under-predicts the variability as the convective activity decreases. 

Next, we include the variations in $\langle m \rangle$ (Fig.~\ref{fig:scatter}f) in the predictions, so that they now match the original CC06 theory (Fig.~\ref{fig:scatter}d,e). Including variation in the mean cloud mass flux reduces the fluctuations of the predictions (as visible by the error bars). This is particularly pronounced for small $n$ where the diurnal variations are also reduced. (CHECK DATA WITHOUT MINMEM FOR SCALE DEPENDENCE) Overall, it seems that there are significant fluctuations in $\langle m \rangle$ for small coarsening scales, where the number of clouds is small. Including these fluctuations in the predictions tends to improve the quality of those predictions. 

To proceed, we now want to test two fundamental assumptions made by CC06: (i) $N$ follows a Poisson distribution (Eq.~\ref{eq:N_dist}) and (ii) $m$ follows an exponential distribution (Eq.~\ref{eq:m_dist}). To do this the theory of random sums \citep{Taylor1998} is used to include deviations from these assumptions in the variance predictions.
\begin{equation} \label{eq:derivation_1}
 \langle (\delta M)^2 \rangle = \langle N \rangle \langle (\delta m)^2 \rangle + \langle m \rangle^2 \langle (\delta N)^2 \rangle
\end{equation}
can be rewritten as
\begin{equation} \label{eq:alpha_beta}
 \langle (\delta M)^2 \rangle= (\alpha + \beta) \langle M \rangle \langle m \rangle,
\end{equation}
where $\alpha = \frac{\langle (\delta N)^2 \rangle}{\langle N \rangle}$ and $\beta = \frac{\langle (\delta m)^2 \rangle}{\langle m \rangle^2}$. Both should be 1 if the CC06 assumptions hold. $\alpha$ is a measure of how clustered the clouds are. Values smaller than one indicate a more regular spacing between the clouds while values larger one indicate preferred clustering. This parameter shows a strong diurnal signal (Fig.~\ref{fig:scatter}i), particularly for larger $n$, with a minimum in clustering from 12--15UTC and increased values towards the evening hours. Another measure of clustering, the RDF confirms this trend (FIG ???). Accounting for the variations of $\alpha$ in the predictions strongly reduces the diurnal signal and the fluctuations of the predictions (Fig.~\ref{fig:scatter}g,h). For all times the theory now seems to over-predict the simulated variance.

The same can be done for $\beta$, which measures if the cloud mass flux distribution is narrower or broader than expected from an exponential distribution. Surprisingly, this parameter shows a dependence on scale (Fig.~\ref{fig:scatter}m). Smaller $n$ have a narrower distribution The reason for this is not clear yet. This behavior does not seem to be a sampling issue caused by an insufficient number of ensemble members (see Appendix ???). Could it be a result of clouds not being point-like? Correcting for these deviations in the predictions increases the mean for smaller $n$, but otherwise does not seem to affect the predictions (Fig.~\ref{fig:scatter}i,l).

Finally, including both, $\alpha$ and $\beta$, in the predictions drastically improves the predictions compared to the original PC08 or CC06 predictions, for small and medium scales up to around 180\,km the predictions are basically perfect in their mean with little variations. For the largest $n$ there still is some over-prediction and a remaining diurnal cycle. The one assumption not taken into account yet is the correlation between $m$ and $N$. Fig ??? Clearly shows that the two are correlated in their mean values. When there are more clouds, they also tend to be larger. 

The most striking signal seems to be caused by the clustering of clouds. There is a diurnal variation of up to 50\% in the predictions which is basically removed by taking $\alpha$ into account. 

\section{Incorporating Julia's model}
Can we make better predictions of the variability using Julia's clustering model. The clustering model has the following input parameters: $N$, $\langle r \rangle$, $c_s$ and $c_r$. The idea would be to use the data from the COSMO simulations to determine the first two parameters and then fit the clustering parameters to match the COSMO results (for example the RDFs). Since $N$ is deterministic in the clustering model, I would suggest drawing $N$ from a Poisson distribution with mean $\langle N \rangle$ given by the COSMO simulations. $\langle r \rangle$ can be determined from the mean cloud size.

One problem is the resolution. In the COSMO simulations $\langle r \rangle = $ which is close to the grid spacing. This indicates that there are many clouds only occupying one grid point making the problem discrete.  

\section{My questions}
\begin{enumerate}
 \item Does the line of reasoning I followed in this draft make sense (i.e. starting with the parameterization problem)? 
 \item For the dataset that I have, are these the important diagnostics? 
 \item I discussed several sensitivities in the Appendices. Do these discussion make sense? Are there any other sensitivities I did not look at, which could be important?
 \item Apart from using Julia's model, are there any further analyses I should do or is this enough for now?
 \item What is the most important result and why is it interesting? What new knowledge do we have now?
\end{enumerate}



\section{Appendix A: Sensitivity to ensemble size}
Since we are sampling a continuous distribution with a finite sized ensemble of simulations it is important to check whether the key results depend on the number of ensemble members. In particular the scale dependence of the $\beta$ parameter we suspected to be a sampling issue. Figs ??? and ??? show the diagnostics evaluated for 50 and 20 ensemble members respectively. The main change is in the x-axis, the total mass flux $M$. This is an artifact of the filtering mentioned in Section ??? which puts a lower threshold on the number of ensemble members which have clouds. This threshold is 5 for both the 20 and 50 member analysis, thereby effectively creating a different minimum $M$. Apart from this analysis artifact, the most values are largely unchanged, indicating that the sampling is robust. The fluctuations about the mean are slightly smaller in the 50 member analysis. In particular the $\beta$ parameter does not seem to depend on the ensemble size. The scale dependence is therefore not simply an issue of sample size. 

\section{Appendix B: Sensitivity to analysis height}
As mentioned in Section ??? the choice of vertical level to compute the mass flux statistics is complicated by the temporal and spatial inhomogeneities in our real world simulations. The goal of this appendix is to assess whether the variation of the key diagnostics with analysis height are significant compared with the temporal variability at one analysis height. Figs ??? to ??? show the diagnostics at 2, 3 and 4\,km height. For most quantities shown the change with height (in this reasonable range) is much smaller than the diurnal variation (see for example $\alpha$). The only exception is the $\beta$ parameter which increases with height. Despite the difficulties in choosing an exact analysis height the results seem to be relatively insensitive from 2--4\,km height, giving us confidence that the results are robust. 



\newpage
\bibliographystyle{ametsoc}
{\small
 \bibliography{library}}

\newpage
\section{Figures}


\begin{figure}[h!]
\noindent \centering
\includegraphics[width=0.98\textwidth]{conceptual.png}\\
\caption{Conceptual picture of stochastic convection parameterizations. Red areas indicate where the stochastic parts are active in PC08 and SPPT.} \label{fig:conceptual}
\end{figure}

\begin{figure}[h!]
\noindent \centering
\includegraphics[width=0.98\textwidth]{2016060400/prec_stamps/stamps_prec_2016060400_ana-m_wat-True_nens-20_time-00140000.png}\\
\caption{(top right) Radar observations, (top row) Three ensemble members, (bottom row) zoom of plot on top and (bottom left) surface elevation} \label{fig:prec_stamps}
\end{figure}

\begin{figure}[h!]
\noindent \centering
\includegraphics[width=0.49\textwidth]{composite/prec_hist/prec_hist_composite_ana-prec_wat-True_height-3000_nens-50_tstart-6_tend-24_tinc-60_minmem-5_dr-1.png}\\
\caption{Precipitation histogram showing the number of grid cells within a specified hourly precipitation range. Values are averaged for all analysis times and days. Additionally the simulation numbers are ensemble averages. The ``no rain'' bin (0--0.1 mm/h) is not shown and accounts for the differences in the total number of shown values.} \label{fig:prec_hist}
\end{figure}

\begin{figure}[h!]
\noindent \centering
\includegraphics[width=0.98\textwidth]{composite/prec_rdf/prec_rdf_composite_ana-prec_wat-True_height-3000_nens-50_tstart-6_tend-24_tinc-60_minmem-5_dr-1.png}\\
\caption{Normalized radial distribution function (RDF) of the hourly precipitation fields for simulations and observations. Every line shown represent an average over three time steps. The maximum search radius is 36$\Delta x$ (approximately 100\,km) a resolution of one $\Delta x$. To identify cloud cloud objects a rain threshold of 1\,mm h$^{-1}$ was used, followed by a separation using the same method described for mass flux objects described in Section~\ref{sec:statistics}.} \label{fig:prec_rdf}
\end{figure}

\begin{figure}[h!]
\noindent \centering
\includegraphics[width=0.98\textwidth]{composite/spectra/spectra_composite_ana-spectra_wat-True_height-3000_nens-50_tstart-3_tend-24_tinc-180_minmem-5_dr-2.png}\\
\caption{Saturation ratio is defined as the difference energy spectrum divided by twice the background energy spectrum for (left) precipitation and (right) kinetic energy (KE). The KE spectrum was averaged from the lowest model level to level 15 (approximately 10\,km height). All spectra are instantaneous and ensemble means, where a reduced 5 member ensemble has been used. For details on the calculation of energy spectra, refer to \cite{Selz2015b}} \label{fig:spectra}
\end{figure}

\begin{figure}[h!]
\noindent \centering
\includegraphics[width=0.98\textwidth]{composite/summary_weather/summary_weather_composite_ana-weather_wat-True_nens-50_tstart-3_tend-24_tinc-30.png}\\
\caption{Time series of (a) hourly rainfall in mm/h, (b) CAPE in J/kg, (c) the convective adjustment time scale in h and (d) the perturbed boundary layer height in m. All values are domain and ensemble averages. Each gray line represents one simulation day. The red line is the mean over all simulation days.} \label{fig:summary_weather}
\end{figure}

\begin{figure}[ht]
\noindent \centering
\includegraphics[width=0.95\textwidth]{2016060400/m/identification/identification_2016060400_ana-m_wat-True_nens-2_time-00140000.png}\\
\caption{Cloud identification algorithm. First, a binary field (c) is created by applying thresholds to the vertical velocity (a) and cloud water (b) fields. Then, the contiguous clouds are identified (d), followed by a separation using a local maximum and watershed method (e)} \label{fig:Fig4}
\end{figure}

\begin{figure}[ht]
\noindent \centering
\includegraphics[width=0.95\textwidth]{composite/M_vert/M_vert_composite_ana-vert_wat-True_height-3000_nens-50_tstart-15_tend-16_tinc-60_minmem-5_dr-2_tplot-0-1.png}\\
\includegraphics[width=0.95\textwidth]{composite/M_vert/M_vert_composite_ana-vert_wat-True_height-3000_nens-50_tstart-18_tend-19_tinc-60_minmem-5_dr-2_tplot-0-1.png}\\
\caption{(Left) Vertical profiles of the domain integrated mass flux for the entire simulation domain (red), and the Southern (green) and Northern (blue) half of the domain for 15UTC (top) and 18UTC (bottom). (Right) Height above sea level for a column located over the ocean.} \label{fig:Fig4}
\end{figure}

\begin{figure}[ht]
\noindent \centering
\includegraphics[width=0.9\textwidth]{composite/std_v_mean/std_v_mean_composite_ana-coarse_wat-True_lev-3000_nens-50.png}\\
\caption{(left column) Scatter plots showing the relation of standard deviations to mean values. Each point represents one time and one box. Lines represent least square fits for $y=bx$ (SPPT, dashed) and $y = (by)^{1/2}$ (CC06, dash-dot). (right column top and bottom) Fit parameter $b$ is shown with dots (SPPT) and crosses (CC06, multiplied by a factor), error bars represent the normalized RMS error of the fits.} \label{fig:std_v_mean}
\end{figure}

\begin{figure}[ht]
\noindent \centering
\includegraphics[width=0.9\textwidth]{composite/scatter/scatter_composite_ana-coarse_wat-True_lev-3000_nens-50.png}\\
\caption{(left column) Ratio of simulated variance to prediction (see label) Each dot represent one time and one coarse box. Large dots represent mean values. Error bars indicate plus/minus one standard deviation. (middle column) Temporal evolution of mean ratio (corresponds to large dots in left column for one time) (right column) Temporal mean evolution of parameter used to refine prediction.} \label{fig:scatter}
\end{figure}

\begin{figure}[ht]
\noindent \centering
\includegraphics[width=0.9\textwidth]{composite/scatter/scatter_composite_ana-coarse_wat-True_lev-3000_nens-20.png}\\
\caption{As above but for 20 ensemble members} \label{fig:scatter_20mem}
\end{figure}

\begin{figure}[ht]
\noindent \centering
\includegraphics[width=0.9\textwidth]{composite/scatter/scatter_composite_ana-coarse_wat-True_lev-2000_nens-20.png}\\
\caption{As above but at 2\,km analysis height for 20 Members} \label{fig:scatter_2000}
\end{figure}

\begin{figure}[ht]
\noindent \centering
\includegraphics[width=0.9\textwidth]{composite/scatter/scatter_composite_ana-coarse_wat-True_lev-4000_nens-20.png}\\
\caption{As above but at 4\,km analysis height or 20 Members} \label{fig:scatter_4000}
\end{figure}



% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=0.49\textwidth]{2016060400/m/M_vert/M_vert_2016060400_ana-m_wat-True_nens-2_tstart-12_tend-13_tinc-60_tplot-0-1.png}\\
% \caption{Vertical mass flux profile for the total domain (average surface height: 247\,m) and the Northern (79\,m) and Southern (415\,m) part of the domain.} \label{fig:Fig5}
% \end{figure}
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=0.95\textwidth]{composite/m/summary_stats/summary_stats_composite_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{(a) Temporal evolution of the domain mean $m$, (b) cloud size, (c) domain total mass flux $M$ and (d) cloud number $N$.} \label{fig:Fig7}
% \end{figure}
% 
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=0.95\textwidth]{composite/m/cloud_stats/cloud_stats_composite_ana-m_wat-True_lev-30_nens-20.png}\\
% \caption{(a) Distribution of cloud size and (b) cloud mass flux. For all times and cases.} \label{fig:Fig8}
% \end{figure}
% 
% % Summary var
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/summary_var/summary_var_composite_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{Time evolution for the mean of several variables.} \label{fig:Fig9}
% \end{figure}
% 
% % RDF
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/rdf/rdf_composite_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{As above but for the composite.} \label{fig:Fig10}
% \end{figure}
% 
% % Scatter
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=0.8\textwidth]{composite/m/scatter/rmse_composite_ana-m_wat-True_lev-30_nens-20.png}\\
% \caption{Scatter plots for several variables. Small dots for each $j$, $n$ is denoted by different colors. The large dots represent the mean values for each $n$.} \label{fig:Fig11}
% \end{figure}

% All plots for level 30 (about 3000m above ground, unless noted otherwise)
% 
% \subsection{Example case: June 4}
% % Prec and W stamps
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{2016060400/m/stamps_w/stamps_w_2016060400_ana-m_wat-True_lev-34_nens-20_time-00140000.png}\\
% \caption{(Top left) Ensemble mean precipitation, (remaining plots) vertical velocity field for the first three ensemble members} \label{fig:ex_stamps_w}
% \end{figure}
% 
% % Cloud statistics
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{2016060400/m/cloud_stats/cloud_stats_2016060400_ana-m_wat-True_lev-30_nens-20_time-00140000.png}\\
% \caption{Cloud statistics for one time step (14UTC): (left) Histogram of cloud size (15 bins with width 0.13e8 m$^2$) (right) histogram of $m$ (15 bins with width 0.5e8 kg/s). Red lines show the mean value.} \label{fig:ex_cloud_stats}
% \end{figure}
% 
% % Summary stats
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/summary_stats/summary_stats_composite_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{Time evolution of (top left) the total mass flux integrated over the analysis domain, (top right) the mean cloud size, (bottom left) the mean mass flux per cloud $\langle m \rangle$ and (bottom right) the domain mean convective time scale} \label{fig:comp_summary_stats}
% \end{figure}
% 
% % RDF
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{2016060400/m/rdf/rdf_2016060400_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{Radial distribution function averaged for 3\,h intervals} \label{fig:ex_rdf}
% \end{figure}
% 
% % RDF
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/rdf/rdf_composite_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{As above but for the composite.} \label{fig:comp_rdf}
% \end{figure}
% 
% % Var stamps
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{2016060400/m/stamps_var/stamps_var_2016060400_ana-m_wat-True_lev-34_nens-20_time-00140000_n-64.png}\\
% \caption{For one time (14UTC) and one $n=64$: (Top left) Ensemble mean convective timescale, (top right) $\mu_{2\,j,n}\langle N \rangle_{j,n}$, (bottom left) $\frac{\langle (\delta N)^2 \rangle_{j,n}}{\langle N \rangle_{j,n}}$ and (bottom right) $\frac{\mu_{2\,j,n}\langle N\rangle_{j,n}}{1 + \alpha_{j,n}}$} \label{fig:ex_stamps_var}
% \end{figure}
% 
% % % Scatter
% % \begin{figure}[ht]
% % \noindent \centering
% % \includegraphics[width=0.8\textwidth]{2016060400/m/scatter/scatter_2016060400_ana-m_wat-True_lev-30_nens-20.png}\\
% % \caption{Scatter plots for several variables. Small dots for each $j$, $n$ is denoted by different colors. The large dots represent the mean values for each $n$.} \label{fig:ex_scatter}
% % \end{figure}
% 
% % Scatter
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=0.8\textwidth]{composite/m/scatter/scatter_composite_ana-m_wat-True_lev-30_nens-20.png}\\
% \caption{Scatter plots for several variables. Small dots for each $j$, $n$ is denoted by different colors. The large dots represent the mean values for each $n$.} \label{fig:comp_scatter}
% \end{figure}
% 
% % % Summary var
% % \begin{figure}[ht]
% % \noindent \centering
% % \includegraphics[width=\textwidth]{2016060400/m/summary_var/summary_var_2016060400_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% % \caption{Time evolution for the mean of several variables.} \label{fig:ex_summary_var}
% % \end{figure}
% 
% % Summary var
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/summary_var/summary_var_composite_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{Time evolution for the mean of several variables.} \label{fig:comp_summary_var}
% \end{figure}
% 
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/summary_var/summary_var_composite_ana-m_wat-True_lev-30_nens-20_tstart-3_tend-24_tinc-60.png}\\
% \caption{As above but with 50 ensemble members.}
% \end{figure}
% 
% % Height var
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/height_var/height_var_composite_ana-m_wat-True_nens-20_tstart-3_tend-24_tinc-60_tplot-6-9.png}\\
% \caption{Height evolution for the mean of several variables for the interval 9UTC--11UTC.} \label{fig:comp_height_var}
% \end{figure}
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/height_var/height_var_composite_ana-m_wat-True_nens-20_tstart-3_tend-24_tinc-60_tplot-9-12.png}\\
% \caption{Height evolution for the mean of several variables for the interval 12UTC--14UTC.} 
% \end{figure}
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/height_var/height_var_composite_ana-m_wat-True_nens-20_tstart-3_tend-24_tinc-60_tplot-12-15.png}\\
% \caption{Height evolution for the mean of several variables for the interval 15UTC--17UTC.}
% \end{figure}
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/height_var/height_var_composite_ana-m_wat-True_nens-20_tstart-3_tend-24_tinc-60_tplot-15-18.png}\\
% \caption{Height evolution for the mean of several variables for the interval 18UTC--20UTC.}
% \end{figure}
% 
% % Std_v_mean
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{composite/m/std_v_mean/std_v_mean_composite_ana-m_wat-True_lev-30_nens-20.png}\\
% \caption{Relation between $\sigma_M$ and $M$. The dashed line indicates a linear relationship, while the dash-dotted line indicates a square root relationship.} \label{fig:comp_std_v_mean}
% \end{figure}
% 
% 
% % Var stamps
% \begin{figure}[ht]
% \noindent \centering
% \includegraphics[width=\textwidth]{2016060400/m/stamps_var/new_stamps_var_2016060400_ana-m_wat-True_lev-30_nens-20_time-00140000_n-32.png}\\
% \caption{For one time (14UTC) and one $n=64$: (Top left) Ensemble mean convective timescale, (top right) } \label{fig:ex_stamps_corr}
% \end{figure}

% Loop
% \foreach \x in {2016052800,2016052900,2016053000,2016053100,2016060200,2016060400,2016060500,2016060600,2016060700,2016060800}
% {
% \subsection{\x}
% 
% \clearpage
% }




\end{document}